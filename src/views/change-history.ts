import { LitElement, html, css, nothing } from "lit";
import { customElement, property, state } from "lit/decorators.js";
import { sharedStyles } from "../styles";
import { getChangeHistory, clearChangeHistory } from "../api";
import { localize } from "../localize";
import { showConfirmationDialog, showToast } from "../ha-helpers";
import type { HomeAssistant, HistoryEntry } from "../types";

@customElement("hm-change-history")
export class HmChangeHistory extends LitElement {
  @property({ attribute: false }) public hass!: HomeAssistant;
  @property() public entryId = "";
  @property() public filterDevice = "";

  @state() private _entries: HistoryEntry[] = [];
  @state() private _total = 0;
  @state() private _loading = true;
  @state() private _error = "";
  @state() private _expandedEntries: Set<string> = new Set();

  updated(changedProps: Map<string, unknown>): void {
    if (
      (changedProps.has("entryId") || changedProps.has("filterDevice")) &&
      this.entryId
    ) {
      this._fetchHistory();
    }
  }

  private async _fetchHistory(): Promise<void> {
    this._loading = true;
    this._error = "";
    try {
      const result = await getChangeHistory(
        this.hass,
        this.entryId,
        this.filterDevice
      );
      this._entries = result.entries;
      this._total = result.total;
    } catch (err) {
      this._error = String(err);
    } finally {
      this._loading = false;
    }
  }

  private _l(key: string, params?: Record<string, string | number>): string {
    return localize(this.hass, key, params);
  }

  private _handleBack(): void {
    this.dispatchEvent(new CustomEvent("back", { bubbles: true, composed: true }));
  }

  private _toggleEntry(key: string): void {
    const next = new Set(this._expandedEntries);
    if (next.has(key)) {
      next.delete(key);
    } else {
      next.add(key);
    }
    this._expandedEntries = next;
  }

  private async _handleClear(): Promise<void> {
    const confirmed = await showConfirmationDialog(this, {
      title: this._l("change_history.clear_confirm_title"),
      text: this._l("change_history.clear_confirm_text"),
      confirmText: this._l("change_history.clear"),
      dismissText: this._l("common.cancel"),
      destructive: true,
    });
    if (!confirmed) return;

    try {
      const result = await clearChangeHistory(this.hass, this.entryId);
      if (result.success) {
        showToast(this, {
          message: this._l("change_history.clear_success", { count: result.cleared }),
        });
        this._entries = [];
        this._total = 0;
      }
    } catch {
      showToast(this, { message: this._l("channel_config.save_failed") });
    }
  }

  private _formatTimestamp(ts: string): string {
    try {
      const date = new Date(ts);
      return date.toLocaleString(this.hass.config.language || "en");
    } catch {
      return ts;
    }
  }

  private _getSourceLabel(source: string): string {
    switch (source) {
      case "manual":
        return this._l("change_history.source_manual");
      case "import":
        return this._l("change_history.source_import");
      case "copy":
        return this._l("change_history.source_copy");
      default:
        return source;
    }
  }

  render() {
    return html`
      <button class="back-button" @click=${this._handleBack}>
        \u25C2 ${this._l("common.back")}
      </button>

      <div class="history-header-bar">
        <h2>${this._l("change_history.title")}</h2>
      </div>

      ${this._loading
        ? html`<div class="loading">${this._l("common.loading")}</div>`
        : this._error
          ? html`<div class="error">${this._error}</div>`
          : this._entries.length === 0
            ? html`<div class="empty-state">${this._l("change_history.empty")}</div>`
            : this._renderEntries()}

      ${!this._loading && this._entries.length > 0
        ? html`
            <div class="action-bar">
              <button class="btn btn-secondary destructive" @click=${this._handleClear}>
                ${this._l("change_history.clear")}
              </button>
            </div>
          `
        : nothing}
    `;
  }

  private _renderEntries() {
    return html`
      <div class="history-list">
        ${this._entries.map((entry, index) => {
          const key = `${entry.timestamp}-${index}`;
          const isExpanded = this._expandedEntries.has(key);
          const changeCount = Object.keys(entry.changes).length;

          return html`
            <div class="history-entry">
              <div
                class="history-entry-header"
                @click=${() => this._toggleEntry(key)}
              >
                <div class="history-entry-info">
                  <div class="history-entry-time">
                    ${this._formatTimestamp(entry.timestamp)}
                  </div>
                  <div class="history-entry-device">
                    ${entry.device_name} (${entry.device_model})
                    \u2014 ${entry.channel_address}
                  </div>
                  <div class="history-entry-meta">
                    ${this._l("change_history.parameters_changed", { count: changeCount })}
                  </div>
                </div>
                <div class="history-entry-badges">
                  <span class="source-badge">${this._getSourceLabel(entry.source)}</span>
                  <span class="expand-icon">${isExpanded ? "\u25BE" : "\u25B8"}</span>
                </div>
              </div>
              ${isExpanded
                ? html`
                    <div class="history-details">
                      ${Object.entries(entry.changes).map(
                        ([param, change]) => html`
                          <div class="change-row">
                            <span class="change-param">${param}</span>
                            <span class="change-values">
                              <span class="change-old">${String(change.old)}</span>
                              \u2192
                              <span class="change-new">${String(change.new)}</span>
                            </span>
                          </div>
                        `
                      )}
                    </div>
                  `
                : nothing}
            </div>
          `;
        })}
      </div>
    `;
  }

  static styles = [
    sharedStyles,
    css`
      .history-header-bar {
        margin-bottom: 16px;
      }

      .history-header-bar h2 {
        margin: 8px 0;
        font-size: 20px;
        font-weight: 400;
      }

      .history-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .history-entry {
        border: 1px solid var(--divider-color, #e0e0e0);
        border-radius: 8px;
        overflow: hidden;
      }

      .history-entry-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        background: var(--secondary-background-color, #fafafa);
        cursor: pointer;
      }

      .history-entry-header:hover {
        background: var(--primary-background-color);
      }

      .history-entry-info {
        flex: 1;
        min-width: 0;
      }

      .history-entry-time {
        font-size: 13px;
        color: var(--secondary-text-color);
      }

      .history-entry-device {
        font-size: 14px;
        font-weight: 500;
        margin-top: 2px;
      }

      .history-entry-meta {
        font-size: 12px;
        color: var(--secondary-text-color);
        margin-top: 2px;
      }

      .history-entry-badges {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-left: 12px;
        flex-shrink: 0;
      }

      .source-badge {
        font-size: 11px;
        padding: 2px 8px;
        border-radius: 12px;
        background: var(--primary-color, #03a9f4);
        color: #fff;
        text-transform: uppercase;
      }

      .expand-icon {
        font-size: 16px;
        color: var(--secondary-text-color);
      }

      .history-details {
        padding: 8px 16px 12px;
        border-top: 1px solid var(--divider-color, #e0e0e0);
      }

      .change-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 4px 0;
        font-size: 13px;
      }

      .change-param {
        font-weight: 500;
        margin-right: 12px;
      }

      .change-values {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .change-old {
        color: var(--error-color, #db4437);
        text-decoration: line-through;
      }

      .change-new {
        color: var(--primary-color, #03a9f4);
        font-weight: 500;
      }

      .btn {
        padding: 8px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-family: inherit;
        border: 1px solid transparent;
      }

      .btn-secondary {
        background: transparent;
        color: var(--primary-text-color);
        border-color: var(--divider-color, #e0e0e0);
      }

      .btn-secondary:hover {
        background: var(--secondary-background-color, #f5f5f5);
      }

      .btn-secondary.destructive {
        color: var(--error-color, #db4437);
        border-color: var(--error-color, #db4437);
      }

      .btn-secondary.destructive:hover {
        background: var(--error-color, #db4437);
        color: #fff;
      }

      @media (max-width: 600px) {
        .history-entry-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 8px;
        }

        .history-entry-badges {
          margin-left: 0;
        }

        .change-row {
          flex-direction: column;
          align-items: flex-start;
          gap: 2px;
        }
      }
    `,
  ];
}
